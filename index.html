<!DOCTYPE html>
<html lang="eng-UK">
<head>
    <!--meta data-->
    <meta name="robots" content="noindex">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="favicon.ico?" type="image/x-icon" />
    <title>DOTS TASK</title>
    <meta name="description" content="UIDMUL-IST1">
    <meta name="author" content="Maja Friedemann (GitHub: https://github.com/MajaFriedemann | email: maja.friedemann@gmail.com)">
    <!--link to AWS/Stitch/MongoDB-->
    <script src="https://s3.amazonaws.com/stitch-sdks/js/library/v3/stable/stitch.min.js"></script>
    <!--jQuery and jQuery plugins -->
    <script src="scripts/external/jquery.min.js"></script>
    <script src="scripts/external/jquery-3.3.1.js"></script>
    <script src="scripts/external/jquery-ui.min.js"></script>
    <script src="scripts/external/jquery.mousewheel.min.js"></script>
    <script src="scripts/external/jquery.scrollify.js"></script>
    <!--jsPsych-->
    <script src="scripts/external/jspsych-6.0.2.js"></script>
    <!--staircase-->
    <script src="scripts/external/Staircase.js"></script>
    <!--Intro.js library-->
    <script src="scripts/external/intro-custom.js"></script>
    <link href="styles/external/introjs.min.css" rel="stylesheet" type="text/css">
    <!--math & stats functions-->
    <script src="scripts/external/seedrandom.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/p5"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/6.2.2/math.js"></script>
    <!--Modernizr-->
    <script src="scripts/external/modernizr-UIDMUL-IST-180521.js"></script>
    <!--custom CSS-->
    <link href="https://use.typekit.net/ivu3ect.css" rel="stylesheet">
    <link href="styles/style.css" rel="stylesheet" type="text/css">
    <!--custom JS: helper functions-->
    <script src="scripts/helper.js"></script>
    <script src="scripts/dots-try.js"></script>
    <!--custom JS: trials using jPsych-->
    <script src="scripts/jpsych/jspsych-consent.js"></script>
    <script src="scripts/jpsych/jspsych-debriefing.js"></script>
    <script src="scripts/jpsych/jspsych-demographics.js"></script>
    <script src="scripts/jpsych/jspsych-dots.js"></script>
    <script src="scripts/jpsych/jspsych-feedback-form.js"></script>
    <script src="scripts/jpsych/jspsych-overconfident-feedback.js"></script>
    <script src="scripts/jpsych/jspsych-underconfident-feedback.js"></script>
    <script src="scripts/jpsych/jspsych-loading.js"></script>
    <script src="scripts/jpsych/jspsych-loading-partner.js"></script>
    <script src="scripts/jpsych/jspsych-message-splash.js"></script>
    <script src="scripts/jpsych/jspsych-partner-message1.js"></script>
    <script src="scripts/jpsych/jspsych-partner-message2.js"></script>
    <script src="scripts/jpsych/jspsych-notice.js"></script>
    <script src="scripts/jpsych/jspsych-PIS.js"></script>
    <script src="scripts/jpsych/jspsych-score-reveal.js"></script>
</head>

<body></body>

<script>
    /* The following are global variables (available across plugins).
    (note: these must be declared directly in <script> and not within $(document).ready)
    */

    /* PROLIFIC PARAMETERS */

    var ProlificID = getUrlVars()['PROLIFIC_PID'];
    console.log(ProlificID);
    // NOTE ADD COMPLETION CODE HERE!
    var completionCode = "DEE7049F";
    var completionURL = "https://app.prolific.ac/submissions/complete?cc=" + completionCode;
    var PHQexclusionURL = "https://app.prolific.ac/submissions/complete?cc=EXCLU001";

    /* EXPERIMENT INFORMATION */

    var subjectID;
    var studyName = 'Confidence in group decision-making';
    var version = 'strategic version';
    var release_date = '2020/05/12';
    var testing_timeline = false;
    var trialTypeOrder = 'all';          /* "testing" or "all"  |  for "testing" the right click context menu is enabled and the data will be downloaded as a csv file*/
    var scoreRuleOrder;
    var cohort = 'PR';                      /*PR for prolific*/
    var CUREC_studyName = 'Contextual influences on metacognitive judgements';
    var CUREC_ID = 'R67369/RE001';
    var CUREC_version = '5.0';
    var CUREC_date = '2018/11/12';
    var consent_version = '1.0';
    var consent_date = '2020/01/01';
    var PIS_version = '1.0';
    var PIS_date = '2020/01/01';
    var startExperiment = Date.now();
    var currentAttempt = 1;


    /* SEEDED RANDOMISATION
    Get the random subject identifier from cookies, or if there isn't one, set one and make a cookie with the random subject identifier to expire within the year */
    if (getCookie('UIDMUL-IST-subjectID')) {
        subjectID = getCookie('UIDMUL-IST-subjectID');
        //up the number of attempts
        existingAttempts = Number(getCookie('UIDMUL-IST-attempts'));
        currentAttempt = 1 + existingAttempts;
        setCookie('UIDMUL-IST-attempts', currentAttempt, 365);
    } else {
        subjectID = genRandIdentifier(9);
        setCookie('UIDMUL-IST-subjectID', subjectID, 365);
        setCookie('UIDMUL-IST-attempts', currentAttempt, 365);
    }

    // seed the randomisations (whenever a random number is generated it is seeded to the subjectID so that it is reproducible)
    // removing all non-digits from string
    var seed = subjectID.replace(/\D/g,'');
    seed = parseInt(seed);
    Math.seedrandom(seed);



    // randomize partner order
    var partnerOrder = Math.random();  //used to decide if under- or overconfident partner is first

    // randomize color of partner (used for marker color in dots.try and for background color in jspsych-partner-message)
    var color = Math.random();
    var color1;
    var color2;
    var partner1color;
    var partner2color;
    var partner1c;
    var partner2c;
    // if color < 0.5, then the underconfident partner will be gold and the overconfident partner will be purple
    if (color < 0.5) {
        color1 = "yellow";
        color2 = "magenta";
        // if partnerOrder > 0.5, then the underconfident partner will be the first one and overconfident partner the second one
        if (partnerOrder > 0.5) {
            partner1color = "yellow";
            partner1c = color1;
            partner2color = "purple";
            partner2c = color2;
        // if partnerOrder < 0.5, then the overconfident partner will be the first one and underconfident partner the second one
        } else {
            partner1color = "purple";
            partner1c = color2;
            partner2color = "yellow";
            partner2c = color1;
        }
    // if color > 0.5, then the underconfident partner will be purple and the overconfident partner will be gold
    } else {
        color1 = "magenta";
        color2 = "yellow";
        // if partnerOrder > 0.5, then the underconfident partner will be the first one and overconfident partner the second one
        if (partnerOrder > 0.5) {
            partner1color = "purple";
            partner1c = color1;
            partner2color = "yellow";
            partner2c = color2;
        // if partnerOrder < 0.5, then the overconfident partner will be the first one and underconfident partner the second one
        } else {
            partner1color = "yellow";
            partner1c = color2;
            partner2color = "purple";
            partner2c = color1;
        }
    }



    /* IMAGES TO PRELOAD */
    var images = [
        'assets/oxford-logo.jpg',
        'assets/checkmark-white.svg',
        'assets/checkmark-black.svg',
        'assets/down-arrow-2.svg',
        'assets/up-arrow.svg',
        'assets/dotTask_2.5.0 practice.gif',
        'assets/dotTask_2.4.0.gif',
        'assets/dotTask_2.6.0.gif',
        'assets/partner.png',
    ];

    var dotsStaircase = new Staircase({
        logSpace: {
            firstVal: 100,
            down: 2,
            up: 1,
            wait: true,
            operation: 'logspace',          // accuracy is staircased to .71
            breaks: [0, 5, 10],
            stepSizeDown: [0.4, 0.2, 0.1],
            stepSizeUp: [0.4, 0.2, 0.1],
            direction: -1,
            limits: [1, 100],
            verbosity: 1
        }
    });

    dotsStaircase.init();

    /* DATA VARIABLES */
    var dots_totalTrials = 0;
    var dots_totalCorrect = 0;
    var dots_jointTotalCorrect = 0;
    var dots_blockCount = 0;
    var dotsBlockCounter = 0;
    var staircaseSteps = 0;
    var dots_cumulativeScore = 0;
    var dots_overallAccuracy = 0;
    var dots_jointOverallAccuracy = 0;
    var accuracy = 0;
    var participantAccu;
    var partnerAccu;
    var participantChosen = 0;
    var partner;
    var trialsPerBlock = 20; //make trial count 20 here (5x20 trials = 100 trials per partner)
    var dotCountHigherList = [];
    var finalHigh;

    var bonusPayment = 0;

    var dataObject = {
        trial_count: [],
        block_count: [],
        subjectID: subjectID,
        prolificID: ProlificID,
        experiment_version: version,
        experiment_version_date: release_date,
        experiment_condition: undefined,
        trialType_order: trialTypeOrder,
        scoreRule_order: scoreRuleOrder,
        attempts: currentAttempt,

        CUREC_ID: CUREC_ID,
        CUREC_version: CUREC_version,
        CUREC_date: CUREC_date,
        PIS_version: PIS_version,
        PIS_date: PIS_date,
        PIS_acknowledged: undefined,
        consent_version: consent_version,
        consent_date: consent_date,
        consented: undefined,

        age: undefined,
        gender: undefined,
        handedness: undefined,
        demographicsRTs: [],
        demographics_duration: 0,

        dots_accuracy: [],
        //dots_isTutorialMode: [],
        dots_staircase: [],
        dots_majoritySide: [],
        dots_confidences: [],
        initial_choices: [],
        partner_confidences: [],
        dots_pairs: [],
        //dots_defaultOption: [],
        //dots_moreAsked: [],
        dots_isCorrect: [],
        dots_jointCorrect: [],
        dots_partnerCorrect: [],
        dots_RTs: [],
        dots_waitTimes: [],

        technical_issues: undefined,
        feedback_technical: undefined,
        feedback_comments: undefined,
        debriefing: undefined,

    };


    /* EXPERIMENTAL PAGES */

    // ethics
    var PIS = {
        type: 'jspsych-PIS',
        studyName: studyName,
        CUREC_ID: CUREC_ID,
        version: PIS_version,
        date: PIS_date
    };

    var consent = {
        type: 'jspsych-consent',
        studyName: studyName,
        CUREC_ID: CUREC_ID,
        version: consent_version,
        date: consent_date
    };

    var debriefing = {
        type: 'jspsych-debriefing',
        studyName: studyName,
        CUREC_ID: CUREC_ID,
        version: CUREC_version,
        date: CUREC_date
    };

    // demographics
    var demographics = {
        type: 'jspsych-demographics'
    };


    // dot task
    var dotTaskPractice1 = {
        type: 'jspsych-dots',
        dot_minimum: 200,
        canvasWidth: 445,
        canvasHeight: 180,
        leftColor: 'rgb(255,255,255)',
        rightColor: 'rgb(255,255,255)',
        waitTimeLimit: 2000,
        isTutorialMode: true,
        trial_count: 2,             //make trial count 100 here
        yellowButtonEnabled: false,
        greenButtonName: 'CONTINUE',
        seeAgain: 'practice1',
        partner: 'none',
    };


    var dotTaskPractice2 = {
        type: 'jspsych-dots',
        dot_minimum: 200,
        canvasWidth: 445,
        canvasHeight: 180,
        leftColor: 'rgb(255,255,255)',
        rightColor: 'rgb(255,255,255)',
        waitTimeLimit: 2000,
        isTutorialMode: true,
        trial_count: 5,                 //make trial count 5 here
        greenButtonName: 'CONTINUE',
        seeAgain: 'easier',
        partner: 'none'
    };

    var dotTask1 = {
        type: 'jspsych-dots',
        dot_minimum: 200,
        canvasWidth: 445,
        canvasHeight: 180,
        leftColor: 'rgb(255,255,255)',
        rightColor: 'rgb(255,255,255)',
        waitTimeLimit: 2000,
        isTutorialMode: false,
        trial_count: trialsPerBlock,
        blockCounterEnabled: true,
        greenButtonName: 'CONTINUE',
        seeAgain: 'easier',
        partner: 'underconfident'
    };


    var dotTask2 = {
        type: 'jspsych-dots',
        dot_minimum: 200,
        canvasWidth: 445,
        canvasHeight: 180,
        leftColor: 'rgb(255,255,255)',
        rightColor: 'rgb(255,255,255)',
        waitTimeLimit: 2000,
        isTutorialMode: false,
        trial_count: trialsPerBlock,
        blockCounterEnabled: true,
        greenButtonName: 'CONTINUE',
        seeAgain: 'easier',
        partner: 'overconfident'
    };


    var dotTaskInstructions1 = {
        type: 'jspsych-notice',
        section1_text: 'In this experiment, you will be playing a game with dots.',
        section2_text: 'During this game, you will see two boxes containing dots briefly flash on either side of the centre of the screen (marked with a "+" sign). Your task is to decide whether the left or right box contains more dots. If you think the left box contained more dots, you respond with a <u>left mouse-click</u>. If you think the right box contained more dots, you respond with a <u>right mouse-click</u>. The task will start off quite easy <u>but will become harder</u> as you progress. ' +
            '<br><br> Press the "continue" button to start the game. <u>The first phase of the game can take up to 8 minutes.</u> You should reach a stable performance level to continue to the next phase.',
        img_id: 'dotTask-gif1'
    };

    var dotTaskInstructions2 = {
        type: 'jspsych-notice',
        section1_text: 'From now on, you will indicate your confidence in your decisions and get feedback if your choice was correct or incorrect.',
        section2_text: 'After responding with a left or right click, you will now <u>indicate your confidence</u> in the decision <u>on a sliding scale</u>. Hover over the slider bar to change the slider position - towards the middle if you aren\'t sure of your answer, and towards the left/right side if you\'re confident that the respective side is the correct answer - then click on the slider bar to register your confidence rating. After you respond, <u>you will get feedback</u> about whether the side you picked was <highlight style="color: rgb(13,255,146)">CORRECT</highlight> or <highlight style="color: rgb(255,0,51)">INCORRECT</highlight>.' +
            ' <br><br>Press the "continue" button to do a few trials with the confidence slider.',
        img_id: 'dotTask-gif2'
    };

    var dotTaskInstructions3 = {
        type: 'jspsych-notice',
        section1_text: 'Great! You are half-way through. For the second half you will be paired with a different partner',
        section2_text: 'Based on your responses, we will select another participant who did about as well as you did on the dot task. Different partner, same rules: After responding with a left or right click and indicating your confidence on the slider, you will see the your partner\'s response for the same dots-grid. Your partner did about as well as you did in the practice trials. The <highlight style="color: rgb(13,255,146)">decision that is reported with HIGHER CONFIDENCE</highlight> will be selected as <highlight style="color: rgb(13,255,146)"> your joint decision</highlight>  based on which you will get feedback. Therefore, if you are sure you got it right, report high confidence such that your decision counts. However, if you are not very sure, it might be best to report low confidence and thus let your partner\'s decision be chosen. <highlight style="color: rgb(13,255,146)">Acting strategic like this is crucial as you will be awarded a cash bonus based on the accuracy of your JOINT decisions.</highlight> <br><br>Press the "continue" button to do 5 more blocks of the dot task.',
        img_id: 'dotTask-gif3'
    };

    var dotTaskStart = {
        type: 'jspsych-notice',
        section1_text: 'You have now completed the first two phases of the dot game.',
        section2_text: 'For the rest of the experiment, you\'ll be doing the task you just practiced. However, from now on you will see the response of another past participant for the same dots-grid. Your partner did about as well as you did in the practice trials. The <highlight style="color: rgb(13,255,146)">decision that is reported with HIGHER CONFIDENCE</highlight> will be selected as <highlight style="color: rgb(13,255,146)"> your joint decision</highlight> based on which you will get feedback. Therefore, if you are sure you got it right, report high confidence such that your decision counts. However, if you are not very sure, it might be best to report low confidence and thus let your partner\'s decision be chosen. <highlight style="color: rgb(13,255,146)">Acting strategic like this is crucial as you will be awarded a cash bonus based on the accuracy of your JOINT decisions.</highlight> <br><br>There will be 10 blocks of 20 trials, which should take approximately 25 minutes to complete altogether. Press "continue" to continue to the first block of 20 trials',
        img_id: 'dotTask-gif3'
    };

    // var dotTaskStart = {
    //     type: 'jspsych-message-splash',
    //     name: 'dotStart',
    //     subjectID: subjectID,
    //     message: 'You have now completed the practice trials for the dot task.',
    //     submessage: 'For the rest of the experiment, you\'ll be doing the task you just practiced. However, from now on you will see the <u>response of another past participant</u> for the same dots-grid. This other participant <u>did about as well as you did</u> in the practice trials. The <u>decision that is reported with higher confidence</u> will be selected as  <highlight style="color: rgb(13,255,146)"> <u>your joint decision</u> </highlight>  based on which you will get feedback.<br><br>In the example on the left, the other participant\'s choice was reported with higher confidence and thus chosen as the joint decision.  There will be <u>four blocks of 50 trials</u>, which should take approximately 25 minutes to complete altogether. You will be able to take a short break in between the blocks. <br><br> <highlight style="color: rgb(13,255,146)">A cash bonus will be awarded based on the accuracy of your joint decisions.</highlight> <br><br> Press "continue" to continue to the first block of 50 trials.',
    //     backgroundColor: 'rgb(0,0,0)',
    //     buttonEnabled: true,
    //     buttonText: 'CONTINUE',
    //     lineSpacing: '130%',
    //     submessageSize: '2.8vmin'
    // };


    var partner1 = {
        type: 'jspsych-partner-message1',
        section2_text: 'We have selected your first partner! <br><br>Their decision and confidence rating will be indicated with a <highlight style="color: ' + partner1c +  '" >' + partner1color + ' </highlight> bar. <br><br>The decision reported with<highlight style="color: rgb(13,255,146)"> higher confidence</highlight> will be selected as your joint decision.',
        img_id: 'dotTask-partner'
    };

    var partner2 = {
        type: 'jspsych-partner-message2',
        section2_text: 'We have selected your second partner! <br><br>Their decision and confidence rating will be indicated with a <highlight style="color: ' + partner2c +  '" >' + partner2color + ' </highlight> bar. <br><br>The decision reported with<highlight style="color: rgb(13,255,146)"> higher confidence</highlight> will be selected as your joint decision.',
        img_id: 'dotTask-partner'
    };

    var dotTaskRest = {
        type: 'jspsych-message-splash',
        name: 'dotTaskRest',
        subjectID: subjectID,
        message: '',
        variableMessage: 'dotRest flat',
        backgroundColor: 'rgb(0,0,0)',
        buttonEnabled: true,
        buttonText: 'CONTINUE',
        lineSpacing: '130%',
        submessageSize: '2.8vmin'
    };


    var dotsScoreReveal = {
        type: 'jspsych-score-reveal',
        performanceType: 'accuracy',
        bonusThreshold: 60,
        flatBonusAmount: 1
    };

    var thankYou = {
        type: 'jspsych-message-splash',
        name: 'thankYou',
        message: 'Thank you for completing the study! <br> <h4>You will now be returned to Prolific for your participant payment. If you are not automatically redirected in 2 seconds, please click <a href="' + completionURL + '">here</a>.</h4>',
        endPage: true,
        subjectID: subjectID
    };

    var loading = {
        type: 'jspsych-loading',
        subjectID: subjectID
    };

    var loadingPartner = {
        type: 'jspsych-loading-partner',
        subjectID: subjectID
    };

    var questionnaireSplash = {
        type: 'jspsych-message-splash',
        name: 'questionnaireIntro',
        message: 'The experiment starts with a few questions for you.',
        subjectID: subjectID,
        buttonEnabled: true
    };

    var feedbackPoll = {
        type: 'jspsych-feedback-form',
        askStrategy: false
    };

    var feedbackOverconfPartner = {
        type: 'jspsych-overconfident-feedback',
        askStrategy: false
    };

    var feedbackUnderconfPartner = {
        type: 'jspsych-underconfident-feedback',
        askStrategy: false
    };


    /* TIMELINES FOR RELEASE & TESTING */
    switch(trialTypeOrder) {

        case 'all':
            if (partnerOrder > 0.499) {
                var order;
                order = "underconfident, then overconfident";
                dataObject["experiment_condition"] = order;
                var timeline = [
                    //loading,
                    PIS,
                    consent,
                    demographics,
                    dotTaskInstructions1,
                    dotTaskPractice1,
                    dotTaskInstructions2,
                    dotTaskPractice2,
                    dotTaskStart,
                    loadingPartner,
                    partner1,
                    dotTask1,
                    dotTaskRest,
                    dotTask1,
                    dotTaskRest,
                    dotTask1,
                    dotTaskRest,
                    dotTask1,
                    dotTaskRest,
                    dotTask1,
                    dotTaskRest,
                    feedbackUnderconfPartner,
                    dotTaskInstructions3,
                    loadingPartner,
                    partner2,
                    dotTask2,
                    dotTaskRest,
                    dotTask2,
                    dotTaskRest,
                    dotTask2,
                    dotTaskRest,
                    dotTask2,
                    dotTaskRest,
                    dotTask2,
                    dotTaskRest,
                    feedbackOverconfPartner,
                    dotsScoreReveal,
                    feedbackPoll,
                    debriefing,
                    thankYou
                ];
            } else {
                var order;
                order = "overconfident, then underconfident";
                dataObject["experiment_condition"] = order;
                var timeline = [
                    //loading,
                    PIS,
                    consent,
                    demographics,
                    dotTaskInstructions1,
                    dotTaskPractice1,
                    dotTaskInstructions2,
                    dotTaskPractice2,
                    dotTaskStart,
                    loadingPartner,
                    partner1,
                    dotTask2,
                    dotTaskRest,
                    dotTask2,
                    dotTaskRest,
                    dotTask2,
                    dotTaskRest,
                    dotTask2,
                    dotTaskRest,
                    dotTask2,
                    dotTaskRest,
                    feedbackOverconfPartner,
                    dotTaskInstructions3,
                    loadingPartner,
                    partner2,
                    dotTask1,
                    dotTaskRest,
                    dotTask1,
                    dotTaskRest,
                    dotTask1,
                    dotTaskRest,
                    dotTask1,
                    dotTaskRest,
                    dotTask1,
                    dotTaskRest,
                    feedbackUnderconfPartner,
                    dotsScoreReveal,
                    feedbackPoll,
                    debriefing,
                    thankYou
                ];
            }
            break;

        case 'testing':
            if (partnerOrder > 0.5) {
                var timeline = [
                    dotTaskInstructions1,
                    dotTaskPractice1,
                    dotTaskInstructions2,
                    dotTaskPractice2,
                    dotTaskStart,
                    thankYou
                ];
            } else {
                var timeline = [
                    dotTaskInstructions1,
                    dotTaskPractice1,
                    dotTaskInstructions2,
                    dotTaskPractice2,
                    dotTaskStart,
                    thankYou
                ];
            }
            break;


        default:
            var timeline = [loading];
    }

    /* JSPSYCH & MONGODB */

    jsPsych.init({
        timeline: timeline,
        preload_images: images,
        show_preload_progress_bar: false, // hide preload progress bar
        on_finish: function() {
            var endExperiment = Date.now();
            var testTime = msToMinSec(endExperiment - startExperiment);
            // link up to Stitch with a promise
            var clientPromise = stitch.StitchClientFactory.create('uidmul-ist-sbgze');
            // add all experimental details to dataObject
            dataObject["dots_staircase"] = dotsStaircase.get('logSpace');
            dataObject["dots_overallAccuracy"] = dots_overallAccuracy;
            dataObject["bonus_earned"] = bonusPayment;
            dataObject["date_completed"] = longformDate();
            dataObject["duration"] = testTime;

            saveCSV(subjectID, currentAttempt);


            // link up to Stitch
            clientPromise.then(client => {
                const db = client.service('mongodb', 'mongodb-atlas').db('IST');
                client.login().then(() => {
                    db.collection('IST1').insertOne(dataObject)
                }).then(() => {
                    console.log('[MongoDB Stitch] Connected to Stitch with insertOne');
                }).catch(err => {
                    console.error(err);
                });
            });
        }
    });
</script>
</html>